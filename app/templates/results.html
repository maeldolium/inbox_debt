{% extends "base.html" %}
{% block title %}Inbox Debt — Résultats{% endblock %}

{% block content %}
 <div class="row justify-content-center">
    <div class="col-12 col-lg-7">
        <div class="card shadow-sm border-0">
            <div class="card-body p-4">
                <h1 class="h4 mb-2">Résultats de la recherche</h1>
                {% if last_updated_at %}
                <p class="text-muted small mb-4">Analyse effectuée à {{ last_updated_at.strftime('%H:%M') }} — Recherche: <code>{{ last_query }}</code></p>
                {% endif %}
                <p class="text-muted mb-4">Voici les mails correspondant à la recherche. Vous pouvez choisir quels mails supprimer et lesquels placer dans la safelist.</p>
                
                <form action="" method="post" id="deleteForm">
                    <div class="search-wrapper">
                        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="domainFilter" class="search-input" placeholder="Rechercher">
                    </div>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Domaine</th>
                                <th scope="col">Nombre</th>
                                <th scope="col">Action</th>
                            </tr>
                        </thead>

                        <tbody>
                            {% for domain, info in data.items() %}
                            <tr>
                                <th scope="row" class="align-middle"><a href="{{ url_for('view_domain', domain=domain) }}" class="text-decoration-none text-black">{{ domain }}</a></th>
                                <td class="align-middle">{{ info.count }}</td>
                                <td class="align-middle d-flex justify-content-evenly">
                                    <button type="submit" name="domain" value="{{ domain }}" data-domain="{{ domain }}" data-count="{{ info.count }}" formaction="{{ url_for('delete') }}" class="btn btn-delete btn-app">
                                        Supprimer
                                    </button>
                                    <button type="submit" name="domain" value="{{ domain }}" data-domain="{{ domain }}" formaction="{{ url_for('add_safelist') }}" class="btn btn-safelist btn-app">
                                        Safelist
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </form>

                    <a href="/" class="btn btn-primary btn-app">Retour</a>

            </div>
        </div>
    </div>
 </div>
 {% endblock %}

 {% block scripts %}
 <script>
    // Filtre des domaines
    const domainFilter = document.getElementById("domainFilter");
    const tbody = document.querySelector("tbody");
    const rows = tbody.querySelectorAll("tr");

    domainFilter.addEventListener("input", (event) => {
        const filterValue = event.target.value.toLowerCase();
        
        rows.forEach((row) => {
            const firstCell = row.querySelector("th");
            const domainText = firstCell.textContent.trim().toLowerCase();
            
            if (domainText.includes(filterValue)) {
                row.classList.remove("d-none");
            } else {
                row.classList.add("d-none");
            }
        });
    });

    // Récupère tous les boutons
    const deleteButtons = document.querySelectorAll(".btn-delete");
    const safelistButtons = document.querySelectorAll(".btn-safelist");
    const allButtons = document.querySelectorAll(".btn-delete, .btn-safelist");

    // Fonction générique pour gérer la désactivation des boutons
    function handleButtonAction(btn, confirmMessage, loadingText) {
        const ok = window.confirm(confirmMessage);
        if (!ok) {
            event.preventDefault();
            return;
        }

        // Désactive tous les boutons
        allButtons.forEach((b) => {
            if(b !== btn) {
                b.disabled = true;
            }
        });
    }

    // Gestion des clics sur les boutons de suppression
    deleteButtons.forEach((btn) => {
        btn.addEventListener("click", (event) => {
            const domain = btn.dataset.domain;
            const count = btn.dataset.count;
            handleButtonAction(btn, `Supprimer ${count} mails de ${domain} ?`, " Suppression…");
        });
    });

    // Gestion des clics sur les boutons safelist
    safelistButtons.forEach((btn) => {
        btn.addEventListener("click", (event) => {
            const domain = btn.dataset.domain;
            handleButtonAction(btn, `Ajouter ${domain} à la safelist ?`, " Ajout…");
        });
    });
</script>
{% endblock %}